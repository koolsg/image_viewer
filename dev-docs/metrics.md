Metrics and Diagnostics
=======================

This document describes the minimal in-process metrics available for
development and CI debugging. The project ships a lightweight collector
(`image_viewer/image_engine/metrics.py`) which records simple counters and
timings.

Available keys (examples):
- `db_operator.write_queued` - number of scheduled write tasks
- `db_operator.read_queued` - number of scheduled read tasks
- `db_operator.write_retries` - retry attempts for write operations
- `db_operator.task_duration` - durations for DB tasks (list)

# Thumbnail / EngineCore metrics (2025-12-22)
- `thumb_db.connects` - number of times `ThumbDB.connect()` was called
- `thumbdb.upserts` - number of thumbnail upserts performed via `ThumbDBBytesAdapter`
- `thumbdb.probes` - number of metadata/thumbnail probe reads
- `thumbdb.corrupt_blob_clears` - number of times a corrupt thumbnail BLOB was cleared
- `engine_core.thumb_db_chunks` - number of DB chunk loads processed by `EngineCore` (DB preload)
- `fs_db_worker.chunk_rows_read` - number of rows read by `FSDBLoadWorker` during preload
- `engine_core.thumb_generated` - number of thumbnails generated by `EngineCore`
- `engine_core.thumb_decode_duration` - timings (list) for thumbnail decode operations (ms)
- `engine_core.thumb_db_upsert_duration` - timing for DB upsert operations (ms)
- `engine_core.thumb_request_dedupe` - number of duplicate thumbnail requests suppressed by `_thumb_pending`/_thumb_done

Notes:
- Metric names use a simple dotted namespace for easy filtering and attribution. Timing metrics are reported as lists of durations; counters are simple integers.

How to access metrics in a running process
-----------------------------------------
Import and snapshot:

```python
from image_viewer.image_engine.metrics import metrics
print(metrics.snapshot())
```

Testing guidance
----------------
- `tests/test_metrics.py` contains unit tests exercising metrics for
  `DbOperator` and the migration framework.
- The metrics collector supports `metrics.reset()` for test isolation.

Future improvements
-------------------
- Export metrics via a HTTP endpoint or Prometheus client for richer
  observability.
- Add histogram buckets / percentiles for timing metrics.
